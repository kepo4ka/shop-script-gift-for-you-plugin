import{d as U,h as F,J as K,l as V,O as D,o as i,i as k,w as s,A as I,p as m,a as d,e as A,c as _,F as x,b,n as Q,j as N,q as P,a2 as j,aN as ee,u as B,az as te,y as se,t as ae,M as le,k as G,v as H}from"./main-f4d713e0.js";import{W as oe}from"./WaSpinner-012571e7.js";import{C as L}from"./CustomColumn-97fca79e.js";import{C as X,a as Y}from"./ChipsList-110d0801.js";import{a as R}from"./FieldCheckbox-24639e50.js";import{_ as ne}from"./DropdownAddTags.vue_vue_type_script_setup_true_lang-edbf97b0.js";import{u as re}from"./useSortable-4ffbbe69.js";import{_ as ie}from"./WaDialogLoading.vue_vue_type_script_setup_true_lang-2477d44f.js";const ue=["disabled","onClick"],ce=["disabled","onClick"],de={class:"flexbox middle space-4"},ve={key:0,class:"hint"},me=["onClick"],pe={class:"tw-flex-auto tw-truncate"},xe=U({__name:"FormDeleteTag",props:{entityIds:{},entityType:{}},emits:["close"],setup(T,{emit:w}){const u=T,o=F([]),n=F(!0),f=F(""),p=K();g();const h=V(()=>!!o.value.length&&o.value.every(e=>e.selected)),y=V(()=>!!o.value.length&&o.value.some(e=>e.selected));async function g(){n.value=!0;const{data:e,error:c}=await D(V(()=>`crm.tag.list?${ee.stringify({[`${u.entityType}_id`]:u.entityIds})}`),{refetch:!0,immediate:!0}).get().json();n.value=!1,f.value=c.value,e.value&&(o.value=e.value.map(v=>({...v,selected:!1})))}function a(){const e=h.value;o.value.forEach(c=>c.selected=!e)}async function $(){f.value="";const e=o.value.filter(C=>C.selected).map(C=>C.name);if(!e.length)return;const{error:c,execute:v}=p.removeTags(u.entityType,u.entityIds,e);await v(),f.value=c.value,c.value||(p.refetch(),w("close"))}return(e,c)=>(i(),k(j,{"use-cancel-as-button-label":!0,onClose:c[0]||(c[0]=v=>w("close"))},{header:s(()=>[I(m(e.$t("removeTags")),1)]),submit:s(()=>[d("button",{disabled:n.value||!y.value,onClick:A($,["prevent"])},m(e.$t("removeTags")),9,ue)]),error:s(()=>[I(m(f.value),1)]),default:s(()=>[n.value?(i(),k(oe,{key:0})):(i(),_(x,{key:1},[d("button",{type:"button",class:"button light-gray smaller",disabled:!o.value.length,onClick:A(a,["prevent"])},[d("div",de,[b(R,{"model-value":h.value?"1":""},null,8,["model-value"]),d("span",null,m(e.$t("selectAll")),1)])],8,ce),b(L,{space:"6",class:"custom-mt-16"},{default:s(()=>[d("div",{class:Q({"tw-pb-2":o.value.length})},[o.value.length?N("",!0):(i(),_("div",ve,m(e.$t("emptyList")),1)),o.value.length?(i(),k(X,{key:1},{default:s(()=>[(i(!0),_(x,null,P(o.value,v=>(i(),k(Y,{key:v.id+String(v.color),color:v.color,"bg-color":v.bg_color,class:"smaller"},{default:s(()=>[d("a",{onClick:A(C=>v.selected=!v.selected,["prevent"])},[d("span",pe,m(v.name),1),b(R,{"model-value":v.selected?"1":"","fit-content":""},null,8,["model-value"])],8,me)]),_:2},1032,["color","bg-color"]))),128))]),_:1})):N("",!0)],2)]),_:1})],64))]),_:1}))}}),fe=["disabled","onClick"],he={key:0,class:"hint"},ge=["onClick"],ye={class:"tw-flex-auto tw-truncate"},Ne=U({__name:"FormAddTag",props:{entityIds:{},entityType:{}},emits:["close"],setup(T,{emit:w}){const u=T,o=K(),n=F([]),f=F(),p=F("");async function h(){p.value&&n.value.push(p.value),f.value=o.tagAssign(u.entityType,u.entityIds,n.value),await f.value.execute(),f.value.error||w("close")}return(y,g)=>(i(),k(j,{"use-cancel-as-button-label":!0,onClose:g[2]||(g[2]=a=>w("close"))},{header:s(()=>[I(m(y.$t("addTags")),1)]),submit:s(()=>{var a;return[d("button",{disabled:!!((a=f.value)!=null&&a.isFetching)||!n.value.length&&!p.value.length,onClick:A(h,["prevent"])},m(y.$t("save")),9,fe)]}),error:s(()=>{var a;return[I(m((a=f.value)==null?void 0:a.error),1)]}),default:s(()=>[b(L,{space:"6"},{default:s(()=>[d("div",{class:Q(["tw-p-4 tw-rounded-md tw-bg-waBackground",{"tw-pb-2":n.value.length}])},[n.value.length?N("",!0):(i(),_("div",he,m(y.$t("tagsToAssign")),1)),n.value.length?(i(),k(X,{key:1},{default:s(()=>[(i(!0),_(x,null,P(n.value,a=>{var $,e;return i(),k(Y,{key:a,color:($=B(o).tags.find(c=>c.name===a))==null?void 0:$.color,"bg-color":(e=B(o).tags.find(c=>c.name===a))==null?void 0:e.bg_color,class:"smaller"},{default:s(()=>[d("a",{onClick:A(()=>{n.value=n.value.filter(c=>c!==a)},["prevent"])},[d("span",ye,m(a),1)],8,ge)]),_:2},1032,["color","bg-color"])}),128))]),_:1})):N("",!0)],2),b(ne,{modelValue:n.value,"onUpdate:modelValue":g[0]||(g[0]=a=>n.value=a),"entity-ids":u.entityIds,"entity-type":u.entityType,onInput:g[1]||(g[1]=a=>p.value=a)},null,8,["modelValue","entity-ids","entity-type"])]),_:1})]),_:1}))}}),_e=["data-id"],be=d("div",{class:"handle tw-flex tw-justify-center tw-w-4"},[d("i",{class:"fas fa-grip-vertical gray"})],-1),we={class:"small"},$e={class:"small"},Pe=U({__name:"FormFields",props:{scope:{},exceptFields:{},staticFields:{},prepareFetchParams:{type:Function},sortParamsIfFieldRemoved:{}},emits:["close"],setup(T,{emit:w}){const u=T,{data:o,isFetching:n,error:f}=D(`crm.field.list?scope=${u.scope}`).get().json(),p=u.scope==="deal"?te():se(),{fields:h}=ae(p),y=F([]),g=V(()=>{var l;return(l=y.value)==null?void 0:l.filter(r=>r.value).sort((r,t)=>r.sort<0?1:r.sort-t.sort)}),a=V(()=>{var l;return(l=y.value)==null?void 0:l.filter(r=>!r.value)}),$=F(null),e=[...h.value||[]];le(()=>{Array.isArray(o.value)&&(y.value=[...u.staticFields,...o.value.filter(l=>!u.exceptFields.includes(l.id))].reduce((l,r)=>{var z;const{id:t,name:S,hide:M}=r,q=((z=h.value)==null?void 0:z.indexOf(t))??-1;if(l.push({id:t,name:S,hide:M,value:q>-1?"1":"",sort:q}),"fields"in r){const Z=r.fields.map(E=>{var J;const O=`${r.id}:${E.id}`,W=((J=h.value)==null?void 0:J.indexOf(O))??-1;return{id:O,name:`${r.name} â€“ ${E.name}`,hide:M,value:W>-1?"1":"",sort:W}});l.push(...Z)}return l},[]))});function c(){re($,g,{animation:150,handle:".handle"})}async function v(){var t;h.value=Array.from(((t=$.value)==null?void 0:t.querySelectorAll("[data-id]"))||[]).map(S=>S.getAttribute("data-id")??"");const l=u.prepareFetchParams(h.value),{error:r}=await D("crm.user.settings.save").patch(l);r.value||("updateFieldsInAppState"in p&&p.updateFieldsInAppState(l),p.updateFetchParams(C()),w("close"))}function C(){if(u.sortParamsIfFieldRemoved){const l=String(p.fetchParams.sort);return e.includes(l)&&!(h.value||[]).includes(l)?u.sortParamsIfFieldRemoved:{}}return{}}return(l,r)=>(i(),k(j,{onClose:r[0]||(r[0]=t=>w("close"))},{header:s(()=>[I(m(l.$t("selectFields")),1)]),submit:s(()=>[y.value?(i(),_("button",{key:0,class:"button",onClick:v},m(l.$t("save")),1)):N("",!0)]),default:s(()=>[b(ie,{"is-fetching":B(n),error:B(f)},{default:s(()=>[b(L,{space:"4",class:"fields-list"},{default:s(()=>[d("div",{ref_key:"sortableRef",ref:$,class:"tw-bg-waBlank tw-z-20 tw-pb-4 tw-border-0 tw-border-solid tw-border-b tw-border-b-waBorder",onVnodeMounted:c},[(i(!0),_(x,null,P(g.value,t=>G((i(),_("div",{key:t.id,"data-id":t.id,class:"tw-flex tw-items-center tw-space-x-2 tw-mb-1"},[be,b(R,{modelValue:t.value,"onUpdate:modelValue":S=>t.value=S},{default:s(()=>[d("span",we,m(t.name),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])],8,_e)),[[H,!t.hide]])),128))],512),d("div",null,[(i(!0),_(x,null,P(a.value,t=>G((i(),_("div",{key:t.id,class:"tw-flex tw-items-center tw-space-x-2 tw-mb-1"},[b(R,{modelValue:t.value,"onUpdate:modelValue":S=>t.value=S},{default:s(()=>[d("span",$e,m(t.name),1)]),_:2},1032,["modelValue","onUpdate:modelValue"])])),[[H,!t.hide]])),128))])]),_:1})]),_:1},8,["is-fetching","error"])]),_:1}))}});export{Pe as _,Ne as a,xe as b};
