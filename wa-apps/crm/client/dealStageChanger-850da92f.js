import{d as Y,aT as q,h as E,H as ee,ao as te,o as A,i as F,w as g,a as w,p as k,b as G,c as B,k as ae,n as se,aE as ne,j,e as P,A as V,a2 as Z,R as oe,l as R,u as re,t as le,b3 as ie,ae as H,O as x,bt as ue,S as Q,ag as ce}from"./main-f4d713e0.js";import{c as X}from"./emit-2e4d7646.js";import{a as de}from"./alert-68913f0f.js";import{B as U}from"./ButtonSubmit-3daf0653.js";import{F as fe}from"./FieldSelect-9c9c8fcb.js";const ve={class:"gray"},me={class:"smaller break-words"},_e={class:"fields"},he={class:"field"},pe={class:"name"},ge={class:"value"},ye={key:0,class:"field"},Se=w("div",{class:"name"},null,-1),be={class:"value"},we=["placeholder"],Te={key:0,class:"state-error-hint"},L="0",Ce=Y({__name:"FormConfirmLostReasonStage",props:{scopeActions:{},dealName:{}},setup(n){const f=n,o=q({reasonId:"",customText:""}),l=q({reasonId:!1,customText:!1}),h=E(!0),p=E([]),y=E(!1),m=E(""),{lostReasonList:I,changeCloseStage:$}=f.scopeActions,{t:O}=ee();te(async()=>{m.value="";const{error:i,data:c}=await I();c.value&&(h.value=c.value.required,c.value.lostreasons.forEach(a=>{var e;(e=p.value)==null||e.push({id:String(a.id),value:a.name})}),c.value.allow_custom&&p.value.push({id:L,value:O("otherReason")})),m.value=i.value||""});function S(){return Object.values(l).every(i=>i===!1)}function T(){for(const i in l)l[i]=!1}async function N(){var s;if(m.value="",l.reasonId=h.value&&!o.reasonId,l.customText=o.reasonId===L&&!o.customText,!S())return;const i=o.reasonId&&o.reasonId!==L,c=i?Number(o.reasonId):null,a=i?((s=p.value.find(t=>t.id===o.reasonId))==null?void 0:s.value)||"":o.reasonId===L?o.customText:"";y.value=!0;const{error:e}=await $({status_id:"LOST",lost_id:c,lost_text:a});y.value=!1,m.value=e.value||""}return(i,c)=>(A(),F(Z,{"use-cancel-as-button-label":"","hide-close-icon":""},{header:g(()=>[w("div",ve,k(i.$t("closeDeal")),1),w("div",me,k(f.dealName),1)]),default:g(()=>[w("div",_e,[w("div",he,[w("div",pe,k(i.$t("lostReason")),1),w("div",ge,[G(fe,{modelValue:o.reasonId,"onUpdate:modelValue":[c[0]||(c[0]=a=>o.reasonId=a),T],"error-message":l.reasonId?i.$t("validation.required"):void 0,options:p.value},null,8,["modelValue","error-message","options"])])]),o.reasonId===L?(A(),B("div",ye,[Se,w("div",be,[ae(w("input",{"onUpdate:modelValue":c[1]||(c[1]=a=>o.customText=a),type:"text",class:se(["width-100",{"state-error":l.customText}]),placeholder:i.$t("customReason"),onChange:T},null,42,we),[[ne,o.customText]])])])):j("",!0)])]),submit:g(()=>[G(U,{bg:"red","is-fetching":y.value,onClick:P(N,["prevent"])},{default:g(()=>[V(k(i.$t("lost")),1)]),_:1},8,["is-fetching","onClick"])]),error:g(()=>[m.value?(A(),B("span",Te,k(m.value),1)):j("",!0)]),_:1}))}}),ke=["innerHTML"],Ee={key:0,class:"state-error-hint"},De=Y({__name:"FormConfirmChangeStage",props:{scopeActions:{},orderActionData:{}},setup(n){const f=n,o=E(),l=E(!1),h=E(""),p=document.createElement("div");p.innerHTML=f.orderActionData.dialog_html.trim();let y;p&&(y=p.querySelector(".crm-dialog-content"),((e,s)=>{if(y){const t=y.querySelector(e);t instanceof HTMLElement&&(t.style.display=s)}})(".js-form-footer-actions","none")),oe(o,a=>{if(!a)return;const e=a.getElementsByTagName("script");if(e!=null&&e.length){const s=t=>{const _=window.eval;if(typeof _!="function"||t.src){t.remove();const d=document.createElement("script");t.type&&(d.type=t.type),t.src?d.src=t.src:d.innerHTML=t.innerHTML,a.append(d)}else _(t.innerHTML)};Array.from(e).forEach(s),a.querySelectorAll("input.hasDatepicker").forEach(t=>{t.setAttribute("type","date")}),a.querySelectorAll("input.ui-timepicker-input").forEach(t=>{t.setAttribute("type","time")})}});const{formChangeStageOrderAction:m,forceChangeStage:I,closeModal:$}=f.scopeActions,O=R(()=>p.querySelector(".crm-dialog-header").innerText.trim()),S=R(()=>y.innerHTML),T=R(()=>{var e;const a=(e=o.value)==null?void 0:e.getElementsByTagName("form");return a!=null&&a.length?a[0]:null}),N=R(()=>f.orderActionData.action_id!==null&&T.value);async function i(){if(l.value=!0,h.value="",T.value){const a=await m({action_id:String(f.orderActionData.action_id),order_id:f.orderActionData.order_id},T.value);l.value=!1,h.value=a.error.value||""}}async function c(){l.value=!0,h.value="";const a=await I();l.value=!1,a&&(h.value=a.error.value||"")}return(a,e)=>(A(),F(Z,{"use-cancel-as-button-label":"","hide-close-icon":"",onClose:re($)},{header:g(()=>[V(k(O.value),1)]),default:g(()=>[w("div",{ref_key:"contentRef",ref:o,class:"break-words",innerHTML:S.value},null,8,ke)]),submit:g(()=>[N.value?(A(),F(U,{key:0,"is-fetching":l.value,onClick:P(i,["prevent"])},{default:g(()=>[V(k(a.$t("submit")),1)]),_:1},8,["is-fetching","onClick"])):(A(),F(U,{key:1,"is-fetching":l.value,onClick:P(c,["prevent"])},{default:g(()=>[V(k(a.$t("changeStage")),1)]),_:1},8,["is-fetching","onClick"]))]),error:g(()=>[h.value?(A(),B("span",Ee,k(h.value),1)):j("",!0)]),_:1},8,["onClose"]))}}),r=E(null),D=E();function xe(n){const f=q({cbSuccess:null,cbError:null,cbCancel:null}),{tabKeys:o}=le(ie());function l(e,s=null,t){var _,d;switch((_=e.response.value)==null?void 0:_.status){case 409:if(!s)return;D.value=Q(De,{scopeActions:{formChangeStageOrderAction:p,forceChangeStage:I,closeModal:T},orderActionData:s}),D.value.show();break;case 204:X(),o.value.set("dealRemindersTab",Date.now()),n.value&&(r.value?("stage_id"in r.value?a(r.value.stage_id,n.value.stage_id):"status_id"in r.value&&a(null,n.value.stage_id),n.value={...n.value,...r.value,closed_datetime:new Date().toISOString()},r.value=null):a(n.value.stage_id,null)),(d=D.value)==null||d.hide(),S("success");break;default:t&&e.error.value&&de(e.error.value),r.value=null,S("error");break}}async function h(e,s){var u;r.value=e;let t=null;const _=s?{...e,force:!0}:e,d=H.stringify({id:(u=n.value)==null?void 0:u.id}),v=await x(`crm.deal.move?${d}`,{onFetchError(C){if(typeof C.data=="string"){const b=JSON.parse(C.data);b&&"dialog_html"in b&&(t=b)}return C}}).post(_);return l(v,t,!s),v}async function p(e,s){var b,W,J,z,K;const t=ue(s),_=H.stringify(e);r.value&&"lost_id"in r.value&&Object.assign(t,{crm_change_workflow_data:{id:(b=n.value)==null?void 0:b.id,action:r.value.status_id,lost_id:r.value.lost_id,lost_text:r.value.lost_text}});const d=H.stringify(t),{response:v,data:u,error:C}=await x(`crm.deal.shopaction?${_}`,{beforeFetch({options:M}){return M.headers=new Headers(M.headers),M.headers.set("Content-Type","application/x-www-form-urlencoded"),{options:M}}}).post(d).json();return(W=v.value)!=null&&W.ok&&u.value&&n.value?((J=u.value)==null?void 0:J.status_id)===n.value.status_id&&((z=u.value)==null?void 0:z.stage_id)===n.value.stage_id?S("cancel"):(X(),o.value.set("dealRemindersTab",Date.now()),n.value={...n.value,stage_id:u.value.stage_id,funnel_id:u.value.funnel_id,status_id:u.value.status_id,lost_id:u.value.lost_id,lost_text:u.value.lost_text,...typeof u.value.shop_order=="object"?u.value.shop_order:{}},S("success")):S("error"),r.value=null,(K=D.value)==null||K.hide(),{response:v,data:u,error:C}}async function y(e){var s;return e==="LOST"?(D.value=Q(Ce,{scopeActions:{lostReasonList:O,changeCloseStage:m},dealName:((s=n.value)==null?void 0:s.name)||""}),D.value.show(),!1):m({status_id:"WON"})}async function m(e,s){var u;r.value=e;let t=null;const _=s?{...e,force:!0}:e,d=H.stringify({id:(u=n.value)==null?void 0:u.id}),v=await x(`crm.deal.close?${d}`,{onFetchError(C){if(typeof C.data=="string"){const b=JSON.parse(C.data);b&&"dialog_html"in b&&(t=b)}return C}}).post(_);return l(v,t,!s&&(e==null?void 0:e.status_id)==="WON"),v}async function I(){return r.value?"status_id"in r.value?m(r.value,!0):h(r.value,!0):!1}async function $(){var s,t;const e=await x(`crm.deal.reopen?id=${(s=n.value)==null?void 0:s.id}`).post();return((t=e.response.value)==null?void 0:t.status)===204&&n.value&&(n.value={...n.value,status_id:"OPEN"}),l(e,null,!0),e}async function O(){var s;return await x(`crm.deal.lostreason.list?funnel_id=${(s=n.value)==null?void 0:s.funnel_id}`).json()}function S(e){var t;const s=`cb${e[0].toUpperCase()}${e.slice(1)}`;typeof f[s]=="function"&&((t=f[s])==null||t.call(null))}function T(){var e;(e=D.value)==null||e.hide(),S("cancel")}function N(e){f.cbSuccess=e}function i(e){f.cbError=e}function c(e){f.cbCancel=e}function a(e,s){ce().funnels.forEach(t=>{t.deal_count=t.stages.reduce((_,d)=>{const v=d;return v.id===e&&(v.deal_count+=1),v.id===s&&(v.deal_count-=1),_+v.deal_count},0)})}return{modal:D,changeOpenStage:h,formChangeStageOrderAction:p,closeDeal:y,changeCloseStage:m,lostReasonList:O,forceChangeStage:I,reopenDeal:$,closeModal:T,onSuccess:N,onError:i,onCancel:c}}export{xe as u};
