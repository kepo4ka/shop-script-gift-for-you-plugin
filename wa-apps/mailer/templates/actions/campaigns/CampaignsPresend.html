{if $errormsg}
    <p>
        {foreach $errormsg as $e}
            <em class="state-error-hint">{$e}</em>
        {/foreach}
    </p>
{else}

    {if !$scheduled}
        <a href="javascript:void(0)" class="text-light-gray" title="[`Cancel`]" style="position:absolute;top:.5rem;right:1rem;"><i class="fas fa-times"></i></a>
    {/if}

    {$_warning_class = "m-warning-{if empty($cron_ok)}cron-{/if}{if empty($return_path_ok['status'])}return_path-{/if}{if empty($routing_ok)}routing-{/if}reason"}

    {if empty($cron_ok) || empty($return_path_ok['status']) || empty($routing_ok)}
        <h4 class="custom-mb-8 custom-mt-0 {$_warning_class}">[`Warning`]</h4>
    {/if}

    {$_prev_warning_schown = false}

    {if empty($cron_ok)}
        <div id="m-cron-notice">
            <div class="small">
                <p class="custom-mt-8">
                    [`No <tt>cron</tt> jobs, required for long mailings, have been set up for your account.`]
                    <strong>{sprintf_wp('Without <tt>cron</tt> jobs set up, do not close your browser window after clicking on the “%s” button to complete the email sending process.', _w('Launch campaign'))}</strong>
                </p>

                <p>{sprintf_wp(
                    'To ensure that sending is completed without your input, please set up <tt>cron</tt> jobs (<a href="%s" target="_blank">view instructions</a>), with the commands specified below, in your web-hosting control panel:',
                    _w('https://developers.webasyst.com/docs/tips/cron/')
                )}</p>

                <p class="bold">{$cron_command}</p>
            </div>
        </div>
        {$_prev_warning_schown = true}
    {/if}

    {if $return_path_ok['status'] == false}
        {if $_prev_warning_schown}
            <hr class="custom-my-24 {$_warning_class}">
        {/if}
        <p class="small">
            {if $_prev_warning_schown}<i class="fas fa-exclamation-triangle text-orange"></i> {/if}
            {if $return_path_ok['reason'] == 1 || $return_path_ok['reason'] == 2 || $return_path_ok['reason'] == 3}
                [`Return-Path address specified above is not available.`]
            {elseif $return_path_ok['reason'] == 4}
                {sprintf_wp('Return-Path “%s” is forbidden by the sending server.', $return_path_ok['return-path'])}
            {/if}
            [`Return-Path address is used to automatically process bounced emails.`]
        </p>
        {$_prev_warning_schown = true}
    {/if}

    {if empty($routing_ok)}
        {if $_prev_warning_schown}
            <hr class="custom-my-24 {$_warning_class}">
        {/if}
        <p class="small">
            {if $_prev_warning_schown}<i class="fas fa-exclamation-triangle text-orange"></i> {/if}
            [`You have no routing rules defined for Mailer application.`]
            [`Unsubscribe links in your message will not work.`]
            {sprintf_wp('To set up routing rules use %sSite application%s.', '<a href="../site/#/routing/" target="_blank">', '</a>')}
        </p>
        {$_prev_warning_schown = true}
    {/if}

    {if $need_from_replace}
        {if $_prev_warning_schown}
            <hr class="custom-my-24 {$_warning_class}">
        {/if}

        {if !$need_from_replace.spf.is_ok || !$need_from_replace.dkim.is_ok}
            <p class="small">
                {sprintf_wp(
                    'Sender address <em>%s</em> cannot be used for sending email campaigns via the Webasyst service for the following reasons:',
                    $need_from_replace.original_from_email
                )}
            </p>
        {/if}
        <ul>
        {if !$need_from_replace.spf.is_ok}
            {if empty($need_from_replace.spf.record_current)}
                <li class="small">
                {sprintf_wp(
                    _ws('No SPF rules are specified for domain name <em>%s</em>.'),
                    $need_from_replace.domain
                )}
                </li>
            {else}
                <li class="small">
                {sprintf_wp(
                    _ws('Missing necessary SPF rules for domain name <em>%s</em>: Webasyst Email servers’ addresses are not specified as allowed.'),
                    $need_from_replace.domain
                )}
                </li>
            {/if}
        {/if}
        {if !$need_from_replace.dkim.is_ok}
            {if $need_from_replace.dmarc_policy}
                <li class="small">
                {sprintf_wp(
                    _ws('The DMARC policy level of domain name <em>%s</em> is <strong>%s</strong>. A Webasyst Email DKIM domain record is missing.'),
                    $need_from_replace.domain,
                    $need_from_replace.dmarc_policy
                )}
                </li>
            {else}
                <li class="small">
                {sprintf_wp(
                    _ws('No DMARC policy for domain name <em>%s</em> is specified.'),
                    $need_from_replace.domain
                )}
                </li>
            {/if}
        {/if}
        </ul>

        {if $need_from_replace.is_zone_records_just_created}
        <p class="small">
            {sprintf_wp(
                _ws('Necessary records have been added to the DNS zone of domain name <strong>%s</strong>. Please wait for up to 2 days until these changes take effect.'),
                $need_from_replace.domain
            )}
        </p>
        {/if}

        <p class="small">
            [s`To prevent messages from being rejected or marked as SPAM by recipients’ servers, the sender’s information will be replaced as follows in the message headers:`]
            <br><br>
            <span class="bold">From:</span>
            {if !empty($need_from_replace.from_name)}
                {$need_from_replace.from_name|escape} &lt;{$need_from_replace.from_email|escape}&gt;
            {else}
                {$need_from_replace.from_email|escape}
            {/if}
            {if !empty($need_from_replace.reply_to_email)}
                <br>
                <span class="bold">Reply-To:</span>
                {if !empty($need_from_replace.reply_to_name)}
                    {$need_from_replace.reply_to_name|escape} &lt;{$need_from_replace.reply_to_email|escape}&gt;
                {else}
                    {$need_from_replace.reply_to_email|escape}
                {/if}
            {/if}
        </p>
        <a href="javascript:void(0)" class="button nobutton rounded custom-my-8 js-sendercheck-accept" data-from="{$need_from_replace.from_email}"{if !empty($need_from_replace.reply_to_email)} data-reply-to="{$need_from_replace.reply_to_email}"{/if}>
            <i class="fas fa-check"></i> [`Accept replacement`]
        </a>
        <a href="javascript:void(0)" class="button nobutton rounded custom-my-8 js-edit-from">
            <i class="fas fa-pen"></i> [`Edit email From`]
        </a>
        {if !$need_from_replace.is_public_email_provider && !$need_from_replace.is_zone_records_just_created}
            <hr class="custom-my-24">
            {if !$need_from_replace.spf.is_ok || !$need_from_replace.dkim.is_ok}
                <p class="small">
                    {sprintf_wp(
                        _ws('If you do not want such a replacement and would like to use only sender address <em>%s</em> then carry out the following actions (it may be required to wait up to 2 days for these changes to take effect).'),
                        $need_from_replace.original_from_email
                    )}
                </p>
            {/if}
            <ol>
            {if !$need_from_replace.spf.is_ok}
                {if empty($need_from_replace.spf.record_current)}
                    <li class="small custom-mb-24">
                        {sprintf_wp(
                            _ws('Add an SPF record for domain name <strong>%s</strong>:'),
                            $need_from_replace.domain
                        )}
                        <div class="custom-mt-6">
                            [s`Host:`] <code>{$need_from_replace.spf.domain|escape}</code>. [s`Record type:`] <code>TXT</code>.
                            [s`Value:`]
                        </div>
                        <blockquote class="custom-mt-4">
                            <pre class="small" style="overflow-wrap: break-word;">{$need_from_replace.spf.record_required|escape}</pre>
                        </blockquote>
                    </li>
                {else}
                    <li class="small custom-mb-24">
                        {sprintf_wp(
                            _ws('Change the SPF rules of domain name <strong>%s</strong>.'),
                            $need_from_replace.domain
                        )}

                        <div class="custom-mt-6">
                            {sprintf_wp(
                                _ws('To do so, include the Webasyst Email servers’ addresses in the list of allowed email senders for domain name <strong>%s</strong> by adding the <code>%s</code> part to its SPF record.'),
                                $need_from_replace.domain,
                                $need_from_replace.spf.record_include
                            )}
                        </div>
                        <div class="custom-mt-6">
                            {sprintf_wp(
                                _ws('Current SPF record value in the <strong>%s</strong> zone:'),
                                $need_from_replace.spf.domain
                            )}
                        </div>
                        <blockquote class="custom-mt-4">
                            <pre class="small">{$need_from_replace.spf.record_current|escape}</pre>
                        </blockquote>
                        <div class="custom-mt-6">[s`Change this record as follows:`]</div>
                        <blockquote class="custom-mt-4">
                            <pre class="small">{$need_from_replace.spf.record_required}</pre>
                        </blockquote>
                    </li>
                {/if}
            {/if}
            {if !$need_from_replace.dkim.is_ok}
                {if empty($need_from_replace.dmarc_policy)}
                    <li class="small custom-mb-24">
                        {sprintf_wp(
                            _ws('Add a DMARC policy record for domain name <strong>%s</strong>.'),
                            $need_from_replace.domain
                        )}

                        <div class="custom-mt-6">
                            [s`Host:`] <code>_dmarc.{$need_from_replace.domain}</code>.
                            [s`Record type:`] <code>TXT</code>.
                            [s`Value:`] <code>v=DMARC1; p=none</code>.
                        </div>
                    </li>
                {/if}

                {if !empty($need_from_replace.dkim.txt)}
                    <li class="small custom-mb-24">
                        {sprintf_wp(
                            _ws('Add a DKIM record to the DNS zone of domain name <strong>%s</strong>:'),
                            $need_from_replace.domain
                        )}

                        <div class="custom-mt-6">
                            [s`Host:`] <code>{$need_from_replace.dkim.host}</code>. [s`Record type:`] <code>TXT</code>.
                            [s`Value:`]
                        </div>
                        <blockquote class="custom-mt-4">
                            <pre class="small" style="overflow-wrap: break-word;">{$need_from_replace.dkim.txt|escape}</pre>
                        </blockquote>
                    </li>
                {/if}
            {/if}
            </ol>
        {/if}
        {$_prev_warning_schown = true}
    {/if}

    {if $scheduled}
        {if $_prev_warning_schown}
            <hr class="custom-my-24">
        {/if}

        <p class="custom-my-0 flexbox middle wrap vertical">
            <i class="fas fa-clock fa-3x text-blue custom-my-12"></i>
            <span>
                [`Sending is scheduled for`] <strong class="lowercase">{$scheduled_time|wa_datetime:'humandatetime'}</strong>
            </span>
            <span{if !$estimated_duration}  class="custom-mb-16"{/if}>
                {_w('Ready to send to <span class="bold">%d recipients</span>.', 'Ready to send to <span class="bold">%d recipients</span>.', $unique_recipients)}
            </span>
            {if $estimated_duration}
                <span class="custom-mb-16">
                    {sprintf_wp('The sending will take <strong>about %s</strong>.', $estimated_duration)}
                </span>
            {/if}
            <button type="button" class="cancel-schedule button outlined rounded smaller gray custom-mb-12">[`Cancel`]</button>
        </p>
    {elseif empty($need_from_replace)}
        {if $_prev_warning_schown}
            <hr class="custom-my-24 {$_warning_class}">
        {/if}

        <p class="flexbox middle wrap vertical">
            <span{if !$estimated_duration} class="custom-mb-16"{/if}>
                {_w('Ready to send to <span class="bold">%d recipients</span>.', 'Ready to send to <span class="bold">%d recipients</span>.', $unique_recipients)}
            </span>
            {if $estimated_duration}
                <span class="custom-mb-16">
                    {sprintf_wp('The sending will take <strong>%s</strong>.', $estimated_duration)}
                </span>
            {/if}
            <button id="message-send" type="submit" class="button gradient rounded blue larger custom-mb-12 custom-mr-0">
                <i class="fas fa-spin fa-spinner custom-mr-8 hidden"></i><i class="fas fa-paper-plane custom-mr-8"></i> <span>[`Launch campaign`]</span>
            </button>
            <button type="button" class="button nobutton rounded open-schedule-dialog custom-mb-8">
                <i class="fas fa-clock"></i> [`Scheduled sending`]
            </button>
        </p>
    {/if}
{/if}
